# ðŸ“š ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼cronè¨­å®š ãƒ‡ãƒ—ãƒ­ã‚¤ãƒžãƒ‹ãƒ¥ã‚¢ãƒ«

## ðŸš¨ ç¾åœ¨ã®å•é¡Œ

ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒå‹•ä½œã—ã¦ã„ãªã„åŽŸå› ï¼š
- `scheduler-api-server.py` ã®ä¿®æ­£ã¯å®Œäº†æ¸ˆã¿
- ã—ã‹ã—ã€æ–°ã—ã„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ–¹å¼ã«å¿…è¦ãª2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒ¼ãƒãƒ¼ã«è¨­ç½®ã•ã‚Œã¦ã„ãªã„
- ã“ã®ãŸã‚ã€ç¾åœ¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå®Œå…¨ã«åœæ­¢ã—ã¦ã„ã‚‹

## ðŸ› ï¸ å¾©æ—§ä½œæ¥­æ‰‹é †

### ã‚¹ãƒ†ãƒƒãƒ—1: å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ã‚³ãƒ”ãƒ¼

ãƒ­ãƒ¼ã‚«ãƒ«ã® `api-manager` ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã«ã‚ã‚‹ã€ä»¥ä¸‹ã®2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã® `/home/ubuntu/scheduler/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚

1. `api-manager/scheduler/run_if_enabled.py`
2. `api-manager/scheduler/watchme-scheduler-cron`

#### æ–¹æ³•A: è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ï¼ˆæŽ¨å¥¨ï¼‰

```bash
# api-managerãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§å®Ÿè¡Œ
chmod +x deploy-scheduler-cron.sh
./deploy-scheduler-cron.sh
```

#### æ–¹æ³•B: æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«PCã‹ã‚‰å®Ÿè¡Œ
# run_if_enabled.py ã‚’ã‚³ãƒ”ãƒ¼
scp -i ~/watchme-key.pem \
    scheduler/run_if_enabled.py \
    ubuntu@3.24.16.82:/home/ubuntu/scheduler/

# watchme-scheduler-cron ã‚’ã‚³ãƒ”ãƒ¼
scp -i ~/watchme-key.pem \
    scheduler/watchme-scheduler-cron \
    ubuntu@3.24.16.82:/home/ubuntu/scheduler/
```

### ã‚¹ãƒ†ãƒƒãƒ—2: å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž

ã‚µãƒ¼ãƒãƒ¼ã«SSHã§æŽ¥ç¶šã—ã€`run_if_enabled.py` ã«å®Ÿè¡Œæ¨©é™ã‚’ä¸Žãˆã¾ã™ã€‚

```bash
# ã‚µãƒ¼ãƒãƒ¼ã«æŽ¥ç¶š
ssh -i ~/watchme-key.pem ubuntu@3.24.16.82

# å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸Ž
chmod +x /home/ubuntu/scheduler/run_if_enabled.py
```

### ã‚¹ãƒ†ãƒƒãƒ—3: cronè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰€å®šã®å ´æ‰€ã«è¨­ç½®

ã‚µãƒ¼ãƒãƒ¼ä¸Šã§ã€ã‚³ãƒ”ãƒ¼ã—ãŸcronè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚·ã‚¹ãƒ†ãƒ ã®æ­£ã—ã„å ´æ‰€ã«è¨­ç½®ã—ã€é©åˆ‡ãªæ¨©é™ã‚’è¨­å®šã—ã¾ã™ã€‚

```bash
# cronãƒ•ã‚¡ã‚¤ãƒ«ã‚’ /etc/cron.d/ ã«ã‚³ãƒ”ãƒ¼
sudo cp /home/ubuntu/scheduler/watchme-scheduler-cron /etc/cron.d/watchme-scheduler

# é©åˆ‡ãªæ¨©é™ã‚’è¨­å®šï¼ˆé‡è¦ï¼ï¼‰
sudo chmod 644 /etc/cron.d/watchme-scheduler

# ãƒ­ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆã¨æ¨©é™è¨­å®š
sudo mkdir -p /var/log/scheduler
sudo chown ubuntu:ubuntu /var/log/scheduler

# cronã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆé€šå¸¸ã¯è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹ãŒå¿µã®ãŸã‚ï¼‰
sudo systemctl reload cron
```

### ã‚¹ãƒ†ãƒƒãƒ—4: å‹•ä½œç¢ºèª

#### 4.1 æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

ã¾ãšã€æ‰‹å‹•ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ï¼š

```bash
# ã‚µãƒ¼ãƒãƒ¼ä¸Šã§å®Ÿè¡Œ
python3 /home/ubuntu/scheduler/run_if_enabled.py whisper
```

æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼š
- config.json ãŒå­˜åœ¨ã—ãªã„å ´åˆï¼š`è­¦å‘Š: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“`
- APIãŒç„¡åŠ¹ã®å ´åˆï¼š`whisper: ç„¡åŠ¹ - ã‚¹ã‚­ãƒƒãƒ—`
- APIãŒæœ‰åŠ¹ã®å ´åˆï¼š`whisper: æœ‰åŠ¹ - å®Ÿè¡Œé–‹å§‹`

#### 4.2 API Managerã®UIã‹ã‚‰è¨­å®š

1. https://api.hey-watch.me/manager/ ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ†ã‚¹ãƒˆã—ãŸã„APIï¼ˆä¾‹: whisperï¼‰ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ONã«è¨­å®š
3. è¨­å®šã‚’ä¿å­˜ï¼ˆã“ã‚Œã«ã‚ˆã‚Š `/home/ubuntu/scheduler/config.json` ãŒä½œæˆ/æ›´æ–°ã•ã‚Œã‚‹ï¼‰

#### 4.3 ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç›£è¦–

æ¬¡ã®å®Ÿè¡Œæ™‚åˆ»ã¾ã§å¾…ã¡ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã«æ–°ã—ã„ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼š

```bash
# whisperã®ãƒ­ã‚°ã‚’ç¢ºèªï¼ˆæ¯Žæ™‚10åˆ†ã«å®Ÿè¡Œï¼‰
tail -f /var/log/scheduler/scheduler-whisper.log

# cronå…¨ä½“ã®ãƒ­ã‚°ã‚’ç¢ºèª
tail -f /var/log/scheduler/cron.log
```

## ðŸ“… å®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| APIå | å®Ÿè¡Œæ™‚åˆ» | é »åº¦ | å‡¦ç†ã‚¿ã‚¤ãƒ— |
|-------|---------|------|-----------|
| **whisper** | æ¯Žæ™‚10åˆ† | æ¯Žæ™‚é–“ | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ |
| **behavior-features** | æ¯Žæ™‚10åˆ† | æ¯Žæ™‚é–“ | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ |
| **vibe-aggregator** | æ¯Žæ™‚20åˆ† | æ¯Žæ™‚é–“ | ãƒ‡ãƒã‚¤ã‚¹ãƒ™ãƒ¼ã‚¹ |
| **behavior-aggregator** | æ¯Žæ™‚20åˆ† | æ¯Žæ™‚é–“ | ãƒ‡ãƒã‚¤ã‚¹ãƒ™ãƒ¼ã‚¹ |
| **emotion-features** | æ¯Žæ™‚20åˆ† | æ¯Žæ™‚é–“ | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ |
| **emotion-aggregator** | æ¯Žæ™‚30åˆ† | æ¯Žæ™‚é–“ | ãƒ‡ãƒã‚¤ã‚¹ãƒ™ãƒ¼ã‚¹ |
| **vibe-scorer** | 30åˆ† | 3æ™‚é–“ã”ã¨â€» | ãƒ‡ãƒã‚¤ã‚¹ãƒ™ãƒ¼ã‚¹ |

â€» vibe-scorer: 0:30, 3:30, 6:30, 9:30, 12:30, 15:30, 18:30, 21:30

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€ä»¥ä¸‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š

- [ ] `/home/ubuntu/scheduler/run_if_enabled.py` ãŒå­˜åœ¨ã—ã€å®Ÿè¡Œå¯èƒ½
- [ ] `/etc/cron.d/watchme-scheduler` ãŒå­˜åœ¨ã—ã€æ¨©é™ãŒ 644
- [ ] `/var/log/scheduler/` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã€ubuntu ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ›¸ãè¾¼ã¿å¯èƒ½
- [ ] API Manager UIã‹ã‚‰è¨­å®šã‚’ä¿å­˜ã—ã€`/home/ubuntu/scheduler/config.json` ãŒä½œæˆã•ã‚ŒãŸ
- [ ] æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒæˆåŠŸã—ãŸ
- [ ] cronã«ã‚ˆã‚‹è‡ªå‹•å®Ÿè¡ŒãŒå‹•ä½œã—ã¦ã„ã‚‹ï¼ˆãƒ­ã‚°ã§ç¢ºèªï¼‰

## ðŸš¨ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### config.json ãŒä½œæˆã•ã‚Œãªã„

API Manager UIã‹ã‚‰è¨­å®šã‚’ä¿å­˜ã—ã¦ã‚‚ config.json ãŒä½œæˆã•ã‚Œãªã„å ´åˆï¼š

```bash
# æ‰‹å‹•ã§åŸºæœ¬çš„ãª config.json ã‚’ä½œæˆ
cat > /home/ubuntu/scheduler/config.json << 'EOF'
{
  "apis": {
    "whisper": {
      "enabled": true,
      "interval": 1,
      "timeout": 600,
      "max_files": 100
    }
  },
  "global": {
    "enabled": true,
    "timezone": "Asia/Tokyo"
  }
}
EOF

# æ¨©é™è¨­å®š
chmod 644 /home/ubuntu/scheduler/config.json
```

### cronãŒå®Ÿè¡Œã•ã‚Œãªã„

```bash
# cronè¨­å®šãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
grep watchme /var/log/syslog

# cronè¨­å®šã®æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
cat /etc/cron.d/watchme-scheduler

# cronã‚µãƒ¼ãƒ“ã‚¹ã®çŠ¶æ…‹ç¢ºèª
sudo systemctl status cron
```

### å®Ÿè¡Œã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

```bash
# Dockerã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
docker ps | grep watchme-scheduler-prod

# ã‚³ãƒ³ãƒ†ãƒŠã®ãƒ­ã‚°ã‚’ç¢ºèª
docker logs watchme-scheduler-prod --tail 50
```

## ðŸ“ ãƒ¡ãƒ¢

- ã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã¯ã€Œ2å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€ã‚’æŽ¡ç”¨
  - UIå±¤: ON/OFFè¨­å®šã®ã¿ç®¡ç†ï¼ˆconfig.jsonï¼‰
  - cronå±¤: å›ºå®šã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®Ÿè¡Œï¼ˆ/etc/cron.d/ï¼‰
- å®Ÿè¡Œæ™‚åˆ»ã®å¤‰æ›´ã¯ cron ãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†ãŒå¿…è¦ï¼ˆUIã‹ã‚‰ã¯å¤‰æ›´ä¸å¯ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€Docker ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ cron ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®æ›¸ãè¾¼ã¿ã¯è¨±å¯ã—ãªã„